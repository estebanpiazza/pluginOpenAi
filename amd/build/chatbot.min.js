define(["jquery","core/ajax","core/str"],function(a,b,c){"use strict";var d=function(){a(".chatbot-container").each(function(){var d=a(this),e=d.data("contextid"),f=d.find('[id^="chatbot_form_"]'),g=f.attr("id").replace("chatbot_form_",""),h=a("#chatbot_response_"+g),i=a("#chatbot_question_"+g),j=a("#chatbot_button_"+g);j.on("click",function(a){a.preventDefault(),k()}),i.on("keypress",function(a){13===a.which&&(a.preventDefault(),k())});function k(){var d=i.val().trim();if(!d)return void i.focus();c.get_string("js_writing","block_openai_chatbot").then(function(a){j.text(a)}).catch(function(){j.text("Escribiendo...")}),i.prop("disabled",!0),j.prop("disabled",!0);var f='<div class="chatbot-question">📝 '+l(d)+"</div>";c.get_string("js_writing_question","block_openai_chatbot").then(function(a){f+='<div class="chatbot-loading">✍️ '+a+'<span class="chatbot-dots">.</span><span class="chatbot-dots">.</span><span class="chatbot-dots">.</span></div>',h.html(f)}).catch(function(){f+='<div class="chatbot-loading">✍️ Escribiendo pregunta<span class="chatbot-dots">.</span><span class="chatbot-dots">.</span><span class="chatbot-dots">.</span></div>',h.html(f)}),setTimeout(function(){c.get_string("js_thinking","block_openai_chatbot").then(function(a){j.text(a)}).catch(function(){j.text("Pensando...")}),c.get_string("js_assistant_thinking","block_openai_chatbot").then(function(a){var b='<div class="chatbot-question">📝 '+l(d)+"</div>";b+='<div class="chatbot-loading">🤖 '+a+'<span class="chatbot-dots">.</span><span class="chatbot-dots">.</span><span class="chatbot-dots">.</span></div>',h.html(b)}).catch(function(){var a='<div class="chatbot-question">📝 '+l(d)+"</div>";a+='<div class="chatbot-loading">🤖 El asistente está pensando<span class="chatbot-dots">.</span><span class="chatbot-dots">.</span><span class="chatbot-dots">.</span></div>',h.html(a)})},800);var k={methodname:"block_openai_chatbot_ask_question",args:{question:d,blockinstanceid:parseInt(g),contextid:e}};b.call([k])[0].done(function(a){if(a.success){var b='<div class="chatbot-question">📝 '+l(d)+"</div>";b+=a.html,h.html(b)}else{var e='<div class="chatbot-question">📝 '+l(d)+"</div>";c.get_string("js_error_occurred","block_openai_chatbot").then(function(b){e+='<div class="alert alert-danger">'+b+" "+a.message+"</div>",h.html(e)}).catch(function(){e+='<div class="alert alert-danger">An error occurred: '+a.message+"</div>",h.html(e)})}}).fail(function(a){var b='<div class="chatbot-question">📝 '+l(d)+"</div>";c.get_string("js_error_occurred","block_openai_chatbot").then(function(a){b+='<div class="alert alert-danger">'+a+"</div>",h.html(b)}).catch(function(){b+='<div class="alert alert-danger">Network error occurred</div>',h.html(b)})}).always(function(){i.prop("disabled",!1),j.prop("disabled",!1);var a=j.data("original-text");a?j.text(a):c.get_string("ask_button","block_openai_chatbot").then(function(a){j.text(a)}).catch(function(){j.text("Preguntar")}),i.val("").focus()})}})},l=function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return a.replace(/[&<>"']/g,function(a){return b[a]})};return{init:d}});